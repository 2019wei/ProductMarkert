<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./css/style.css">
</head>

<body class="bg-dark fw-bold">
    <div class="container fs-5">
        <!-- topè¿”å› -->
        <div class="top"> <a href="#"><img src="img/top.png" alt=""></a></div>
        <!-- loading -->
        <div class="" id="isLoading"></div>
        
        <div class="header my-2">
            <div class="row">
                <div class="col">
                    <select class="form-select fw-bold" id="selectMarketName">
                        <option value="å°åŒ—ä¸€">å°åŒ—ä¸€</option>
                        <option value="å°åŒ—äºŒ">å°åŒ—äºŒ</option>
                    </select>
                </div>
                <div class="col">
                    <input type="date" id="selectDate">
                </div>
            </div>
        </div>
        <div class="content">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">ğŸ¥¬</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false"> ğŸ</button>
                </li>
              </ul>
              <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                    <div id = "printTableA"></div>
                </div>
                <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
                    <div id = "printTableB"></div>
                </div>
              </div>
        </div>
    </div>

    <script>
        const selectDate = document.getElementById('selectDate') ?? null;
        const selectMarketName = document.getElementById('selectMarketName') ?? null;
        const isLoading = document.getElementById('isLoading') ?? null;
        selectDate.addEventListener("change",DateAndNameChangeEvent);
        selectMarketName.addEventListener("change",DateAndNameChangeEvent);

        let fruitList = [];
        let vegList=[];
        const fruitKeyword = ['é³³æ¢¨'];
        const vegKeyword = ['ç‰ç±³'];
        const favoritesKeyword = [];
        window.onload = pageInit();

        function pageInit() {
            //é è¨­æ—¥æœŸ - ä»Šå¤©
            const now = new Date();
            now.setHours(now.getHours() + 8);
            const today = now.toISOString().split('T')[0];
            selectDate.value = today;
            //é è¨­å¸‚å ´ - å°åŒ—ä¸€
            selectMarketName.value = 'å°åŒ—ä¸€'
            //call è”¬èœæ°´æœapi
            getDataApi();
            // getFruitApi();
            // getVegApi();
            getCookie('favorites')
            showFavorite()
        }
        //åŠ å…¥loading
        function addLoading(){
            isLoading.classList.add("loading");
        }
        //å»é™¤loading
        function removeLoading(){
            isLoading.classList.remove("loading");
        }

        // è·å–cookie
        function getCookie(name) {
            var cookieName = name + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var cookieArray = decodedCookie.split(';');
            for (var i = 0; i < cookieArray.length; i++) {
                var cookie = cookieArray[i];
                while (cookie.charAt(0) == ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(cookieName) == 0) {
                    return cookie.substring(cookieName.length, cookie.length);
                }
            }

            return "";
        }
        // è®¾ç½®cookie
        function setCookie(name, value) {
            document.cookie = name + "=" + value + ";path=/";
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»æ”¶è—
        function isFavorite(id) {
            var favorites = getCookie("favorites").split(",");
            var index = favorites.indexOf(id);
            if (index === -1) {
                favorites.push(id);
            } else {
                favorites.splice(index, 1);
            }
            setCookie("favorites", favorites.join(","));
        }

        // åˆ‡æ¢æ”¶è—çŠ¶æ€
        function toggleFavorite(id) {
            var favorites = getCookie("favorites").split(",");
            var index = favorites.indexOf(id);
            const ele = document.getElementById(id) ?? null;
            if (index === -1) {
                favorites.push(id);
                ele.textContent = 'â¤ï¸';
            } else {
                favorites.splice(index, 1);
                ele.textContent = 'ğŸ¤';
            }

            setCookie("favorites", favorites.join(","));
        }
        //show cookie
        function showFavorite(){
            var favorites = getCookie("favorites").split(",");
            favorites.forEach(element => {
                favoritesKeyword.push(element)
            });
        }

        
        //ç•¶æ—¥æœŸ å¸‚å ´åç¨±æ”¹è®Š
        function DateAndNameChangeEvent(){
            //call è”¬èœæ°´æœapi
            getDataApi();
            // getFruitApi();
            // getVegApi();
        }

        //æ—¥æœŸè½‰æ›
        function TaiwanDate(ADdate) {
            // å°‡æ—¥æœŸå­—ä¸²æ‹†åˆ†æˆå¹´ã€æœˆã€æ—¥
            const parts = ADdate.split('-');
            // å°‡è¥¿å…ƒå¹´è½‰æ›ç‚ºæ°‘åœ‹å¹´
            const yearInROC = parseInt(parts[0]) - 1911;
            const rocDateString = yearInROC.toString() + '-' + parts[1] + '-' + parts[2];
            // "-"æ›¿æ›æˆ"."
            const result = rocDateString.replace(/-/g, ".");
            return result;
        }
        //call api
        function getDataApi(){
            addLoading();
            const replacedString = TaiwanDate(selectDate.value);
            // å®šä¹‰è¦è°ƒç”¨çš„ API åœ°å€å’Œå‚æ•°
            const fruitApi = 'https://data.moa.gov.tw/Service/OpenData/FromM/FarmTransData.aspx';
            const VegApi = 'https://data.moa.gov.tw/Service/OpenData/FromM/FarmTransData.aspx';
            const params1 = { 
                StartDate: replacedString,
                EndDate: replacedString,
                Market: selectMarketName.value,
                TcType: 'N05' };
            const params2 = { 
                StartDate: replacedString,
                EndDate: replacedString,
                Market: selectMarketName.value,
                TcType: 'N04' 
            };

            // ä½¿ç”¨ Axios å¹¶å‘åœ°è°ƒç”¨ä¸¤ä¸ªå¸¦æœ‰å‚æ•°çš„ API
            Promise.all([
                axios.get(fruitApi, { params: params1 }),
                axios.get(VegApi, { params: params2 })
            ])
                .then(responses => {
                    // åœ¨è¿™é‡Œå¤„ç†ä¸¤ä¸ª API çš„å“åº”
                    const response1 = responses[0];
                    const response2 = responses[1];
                    
                    console.log('API 1 æ•°æ®:', response1.data);
                    //console.log('API 2 æ•°æ®:', response2.data);

                    // ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œ
                    fruitList = response1.data;
                    customListSort(fruitList , favoritesKeyword);
                    printTable(fruitList , 'N05');

                    vegList = response2.data;
                    customListSort(vegList , favoritesKeyword);
                    printTable(vegList , 'N04');

                })
                .catch(error => {
                    // å¤„ç†é”™è¯¯
                    console.error('å‘ç”Ÿé”™è¯¯:', error);
                })
                .finally(()=>{
                    removeLoading();
                });

        }
        //æ°´æœapi-æš«æ™‚ä¸ç”¨
        function getFruitApi() {
            const replacedString = TaiwanDate(selectDate.value);
            const params = {
                StartDate: replacedString,
                EndDate: replacedString,
                Market: selectMarketName.value,
                TcType: 'N05'
            }
            axios.get("https://data.moa.gov.tw/Service/OpenData/FromM/FarmTransData.aspx", { params }).then(res => {
                //console.log(res.data);
                if(res.data.length > 0){
                    fruitList = res.data;
                    customListSort(fruitList , fruitKeyword);
                    printTable(fruitList , 'N05');
                };
            });
        }
        //è”¬èœapi-æš«æ™‚ä¸ç”¨
        function getVegApi() {
            const replacedString = TaiwanDate(selectDate.value);
            const params = {
                StartDate: replacedString,
                EndDate: replacedString,
                Market: selectMarketName.value,
                TcType: 'N04'
            }
            axios.get("https://data.moa.gov.tw/Service/OpenData/FromM/FarmTransData.aspx", { params }).then(res => {
                //console.log(res.data);
                if(res.data.length > 0){
                    vegList = res.data;
                    customListSort(vegList , vegKeyword);
                    printTable(vegList , 'N04');

                };
            });
        }
        //Listæ’åº
        function customListSort(itemList , keyword){
            // åŒ…å«å…³é”®å­—çš„å¯¹è±¡æ’å‰é¢çš„æ¯”è¾ƒå‡½æ•°
            const compareByKeyword = (keyword) => (a, b) => {
                // const aContains = keyword.some(kw => a['ä½œç‰©åç¨±'].includes(kw));
                // const bContains = keyword.some(kw => b['ä½œç‰©åç¨±'].includes(kw));
                const aContains = keyword.some(kw => a['ç¨®é¡ä»£ç¢¼']+'_'+a['ä½œç‰©ä»£è™Ÿ'] === kw);
                const bContains = keyword.some(kw => b['ç¨®é¡ä»£ç¢¼']+'_'+b['ä½œç‰©ä»£è™Ÿ'] === kw);

                if (aContains && !bContains) {
                    return -1;
                } else if (!aContains && bContains) {
                    return 1;
                } else {
                    return 0;
                }
            };

            // æ ¹æ®å…³é”®å­—è¿›è¡Œæ’åº
            itemList.sort(compareByKeyword(keyword));
        }

        function printTable(list , ProductType) {
            let str = `
            <table class="table table-dark table-striped">
    <thead>
        <tr>
        <th scope="col">#</th>
        <th scope="col"></th>
        <th scope="col">ä¸Šåƒ¹</th>
        <th scope="col">ä¸­åƒ¹</th>
        <th scope="col">ä¸‹åƒ¹</th>
        </tr>
    </thead>
    <tbody>`
        list.forEach(item => {
            str += `
            <tr>
        <td>${item["ä½œç‰©åç¨±"]}</td>
        `
        let id = `${item['ç¨®é¡ä»£ç¢¼']}_${item['ä½œç‰©ä»£è™Ÿ']}`
        let index = favoritesKeyword.indexOf(id);
        if(index === -1){
            str += `<td id='${id}' onclick=toggleFavorite('${id}') class=''>ğŸ¤</td>`
        }
        else{
            str += `<td id='${id}' onclick=toggleFavorite('${id}') class=''>â¤ï¸</td>`
        }
        

        str+= `
        <td>${item["ä¸Šåƒ¹"]}</td>
        <td>${item["ä¸­åƒ¹"]}</td>
        <td>${item["ä¸‹åƒ¹"]}</td>
        </tr>
            `
        });
        
        // <tr>
        // <th scope="row">1</th>
        // <td>Mark</td>
        // <td>Otto</td>
        // <td>@mdo</td>
        // </tr>
        // <tr>
        // <th scope="row">2</th>
        // <td>Jacob</td>
        // <td>Thornton</td>
        // <td>@fat</td>
        // </tr>
        // <tr>
        // <th scope="row">3</th>
        // <td colspan="2">Larry the Bird</td>
        // <td>@twitter</td>
        // </tr>

    str += `</tbody>
    </table>
            `
            if(ProductType === 'N04') document.getElementById('printTableA').innerHTML = str;
            if(ProductType === 'N05') document.getElementById('printTableB').innerHTML = str;
        }

    </script>
</body>

</html>